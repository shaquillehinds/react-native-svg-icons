//$lf-ignore
const fs = require('fs');
const path = require('path');

const SVG_DIR = path.join(__dirname, '../src/svgs');
const OUTPUT_FILE = path.join(__dirname, '../src/svgs/registry.ts');
const TYPES_FILE = path.join(__dirname, '../src/svgs/types.ts');

function getIconFiles(dir) {
  if (!fs.existsSync(dir)) {
    console.error(`Directory not found: ${dir}`);
    return [];
  }

  return fs
    .readdirSync(dir)
    .filter((file) => file.endsWith('.tsx'))
    .map((file) => file.replace('.tsx', ''))
    .sort();
}

function generateRegistry() {
  const filledDir = path.join(SVG_DIR, 'filled');
  const outlineDir = path.join(SVG_DIR, 'outline');

  const filledIcons = getIconFiles(filledDir);
  const outlineIcons = getIconFiles(outlineDir);

  if (filledIcons.length === 0 && outlineIcons.length === 0) {
    console.error('No icons found in filled or outline directories');
    process.exit(1);
  }

  console.log(`Found ${filledIcons.length} filled icons`);
  console.log(`Found ${outlineIcons.length} outline icons`);

  // Get all unique icon names
  const allIconNames = [...new Set([...filledIcons, ...outlineIcons])].sort();

  // Generate types file
  const typesContent = `// Auto-generated by scripts/generate-icon-registry.js
// Do not edit manually

export type FilledIconName =
${filledIcons.map((name) => `  | '${name}'`).join('\n')};

export type OutlineIconName =
${outlineIcons.map((name) => `  | '${name}'`).join('\n')};

export type IconName = FilledIconName | OutlineIconName;

export type IconNameByType = {
  filled: FilledIconName;
  outline: OutlineIconName;
};
`;

  // Generate registry file with imports
  const registryContent = `// Auto-generated by scripts/generate-icon-registry.js
// Do not edit manually

import type { SvgIcon } from '../index';
import type { FilledIconName, OutlineIconName } from './types';

// Filled icon imports
${filledIcons.map((name) => `import ${sanitizeImportName(name)}Filled from './filled/${name}';`).join('\n')}

// Outline icon imports
${outlineIcons.map((name) => `import ${sanitizeImportName(name)}Outline from './outline/${name}';`).join('\n')}

export const filledIcons: Record<FilledIconName, React.FC<SvgIcon>> = {
${filledIcons.map((name) => `  '${name}': ${sanitizeImportName(name)}Filled,`).join('\n')}
};

export const outlineIcons: Record<OutlineIconName, React.FC<SvgIcon>> = {
${outlineIcons.map((name) => `  '${name}': ${sanitizeImportName(name)}Outline,`).join('\n')}
};

export const iconRegistry = {
  filled: filledIcons,
  outline: outlineIcons,
} as const;
`;

  // Write files
  fs.writeFileSync(TYPES_FILE, typesContent, 'utf-8');
  console.log(`Generated types file: ${TYPES_FILE}`);

  fs.writeFileSync(OUTPUT_FILE, registryContent, 'utf-8');
  console.log(`Generated registry file: ${OUTPUT_FILE}`);

  console.log('\nDone! Update your index.tsx to import from ./svgs/registry');
}

// Sanitize names that start with numbers or have special characters
function sanitizeImportName(name) {
  // If starts with number, prefix with underscore
  let sanitized = name;
  if (/^\d/.test(name)) {
    sanitized = '_' + name;
  }
  // Replace any non-alphanumeric characters (except underscore)
  sanitized = sanitized.replace(/[^a-zA-Z0-9_]/g, '_');
  return sanitized;
}

generateRegistry();
